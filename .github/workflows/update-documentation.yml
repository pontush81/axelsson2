name: Uppdatera Dokumentation

on:
  # KÃ¶r automatiskt varje natt kl 02:00 svensk tid (01:00 UTC)
  schedule:
    - cron: '0 1 * * *'
  
  # TillÃ¥t manuell triggning frÃ¥n GitHub UI
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml
      
      - name: ğŸ“Š Innan scraping - RÃ¤kna artiklar
        run: |
          echo "ğŸ“Š Nuvarande antal artiklar:"
          for dir in documentation/*/; do
            count=$(cat "${dir}index.json" | grep -o '"title"' | wc -l)
            echo "  ${dir%/}: $count artiklar"
          done
      
      - name: ğŸ”„ KÃ¶r full scraping med bilder
        id: scrape
        run: |
          echo "ğŸ”„ Startar full scraping (fÃ¥ngar ALLA Ã¤ndringar)..."
          echo "â° BerÃ¤knad tid: ~2 minuter fÃ¶r 369 artiklar"
          python3 scraper_with_images.py 2>&1 | tee scrape_output.txt || true
          
          echo "âœ… Scraping slutfÃ¶rd"
      
      - name: ğŸ“ˆ Kontrollera om Ã¤ndringar finns
        id: changes
        run: |
          # Kolla endast efter Ã¤ndringar i documentation/-mappen
          if [[ -n $(git status --porcelain documentation/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Ã„ndringar detekterade i documentation/"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Inga Ã¤ndringar i documentation/"
          fi
      
      - name: ğŸ§¹ Cleanup scrape output
        run: |
          rm -f scrape_output.txt scraper.log
      
      - name: ğŸ’¾ Commit och push Ã¤ndringar
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Documentation Bot"
          git config user.email "bot@axelsson2.com"
          
          # RÃ¤kna Ã¤ndringar
          CHANGED_FILES=$(git diff --name-only documentation/ | wc -l)
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
          
          # Commit och push
          git add documentation/
          git commit -m "ğŸ¤– Auto-update dokumentation ($TIMESTAMP) - $CHANGED_FILES filer Ã¤ndrade"
          git push
      
      - name: ğŸ“Š Sammanfattning
        if: always()
        run: |
          echo "## ğŸ“Š Uppdateringssammanfattning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ—“ï¸ **Datum:** $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– **Scraper:** Full scraping med bilder" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            CHANGED=$(git diff HEAD~1 --name-only documentation/ 2>/dev/null | wc -l || echo "0")
            echo "âœ… **Status:** Ã„ndringar committade och pushade" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **Ã„ndrade filer:** $CHANGED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ Vercel deployer nu automatiskt (2-3 min)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Status:** Inga Ã¤ndringar detekterades" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Dokumentationen Ã¤r redan uppdaterad" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ”” Notifiera vid fel
        if: failure()
        run: |
          echo "âŒ Scraping misslyckades!"
          echo "Kolla logs fÃ¶r detaljer"

