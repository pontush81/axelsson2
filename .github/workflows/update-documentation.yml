name: Uppdatera Dokumentation

on:
  # KÃ¶r automatiskt varje natt kl 02:00 svensk tid (01:00 UTC)
  schedule:
    - cron: '0 1 * * *'
  
  # TillÃ¥t manuell triggning frÃ¥n GitHub UI
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml
      
      - name: ğŸ“Š Innan scraping - RÃ¤kna artiklar
        run: |
          echo "ğŸ“Š Nuvarande antal artiklar:"
          for dir in documentation/*/; do
            count=$(cat "${dir}index.json" | grep -o '"title"' | wc -l)
            echo "  ${dir%/}: $count artiklar"
          done
      
      - name: ğŸ”„ KÃ¶r inkrementell scraping
        id: scrape
        run: |
          echo "ğŸ”„ Startar inkrementell scraping..."
          python3 scraper_incremental.py --incremental 2>&1 | tee scrape_output.txt || true
          
          # Extrahera antal Ã¤ndringar
          NEW=$(grep -oP 'ğŸ†• Nya artiklar:\s+\K\d+' scrape_output.txt || echo "0")
          UPDATED=$(grep -oP 'âœï¸\s+Uppdaterade artiklar:\s+\K\d+' scrape_output.txt || echo "0")
          DELETED=$(grep -oP 'âŒ Raderade artiklar:\s+\K\d+' scrape_output.txt || echo "0")
          
          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          
          TOTAL=$((NEW + UPDATED + DELETED))
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Ã„ndringar: $NEW nya, $UPDATED uppdaterade, $DELETED raderade"
      
      - name: ğŸ“ˆ Kontrollera om Ã¤ndringar finns
        id: changes
        run: |
          # Kolla endast efter Ã¤ndringar i documentation/-mappen
          if [[ -n $(git status --porcelain documentation/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Ã„ndringar detekterade i documentation/"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Inga Ã¤ndringar i documentation/"
          fi
      
      - name: ğŸ§¹ Cleanup scrape output
        run: |
          rm -f scrape_output.txt scraper.log
      
      - name: ğŸ’¾ Commit och push Ã¤ndringar
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Documentation Bot"
          git config user.email "bot@axelsson2.com"
          
          # Skapa commit message
          NEW=${{ steps.scrape.outputs.new }}
          UPDATED=${{ steps.scrape.outputs.updated }}
          DELETED=${{ steps.scrape.outputs.deleted }}
          
          MSG="ğŸ¤– Auto-update dokumentation"
          
          if [ "$NEW" -gt 0 ] || [ "$UPDATED" -gt 0 ] || [ "$DELETED" -gt 0 ]; then
            MSG="$MSG\n\n"
            [ "$NEW" -gt 0 ] && MSG="$MSGğŸ†• $NEW nya artiklar\n"
            [ "$UPDATED" -gt 0 ] && MSG="$MSGâœï¸  $UPDATED uppdaterade artiklar\n"
            [ "$DELETED" -gt 0 ] && MSG="$MSGâŒ $DELETED raderade artiklar\n"
          fi
          
          git add documentation/
          git commit -m "$MSG"
          git push
      
      - name: ğŸ“Š Sammanfattning
        if: always()
        run: |
          echo "## ğŸ“Š Uppdateringssammanfattning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ—“ï¸ **Datum:** $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Status:** Ã„ndringar committade och pushade" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Ã„ndringar:" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ†• Nya: ${{ steps.scrape.outputs.new }}" >> $GITHUB_STEP_SUMMARY
            echo "- âœï¸  Uppdaterade: ${{ steps.scrape.outputs.updated }}" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Raderade: ${{ steps.scrape.outputs.deleted }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Status:** Inga Ã¤ndringar detekterades" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ Vercel kommer auto-deploya om Ã¤ndringar finns" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notifiera vid fel
        if: failure()
        run: |
          echo "âŒ Scraping misslyckades!"
          echo "Kolla logs fÃ¶r detaljer"

